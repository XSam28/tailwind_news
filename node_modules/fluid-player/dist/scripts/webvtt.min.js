var WebVTTParser=function(){this.parse=function(e,t){var n=Date.now(),a=0,i=e.split(/\r\n|\r|\n/),r=!1,s=[],l=[];function o(e,t){l.push({message:e,line:a+1,col:t})}var u=i[a],f=u.length,c=0,m="WEBVTT".length;for("\ufeff"===u[0]&&(c=1,m+=1),(f<m||u.indexOf("WEBVTT")!==0+c||f>m&&" "!==u[m]&&"\t"!==u[m])&&o('No valid signature. (File needs to start with "WEBVTT".)'),a++;""!=i[a]&&null!=i[a];){if(o("No blank line after the signature."),-1!=i[a].indexOf("--\x3e")){r=!0;break}a++}for(;null!=i[a];){for(var p;!r&&""==i[a];)a++;if(!r&&null==i[a])break;p={id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",textPosition:50,size:100,alignment:"middle",text:"",tree:null};var d=!0;if(-1==i[a].indexOf("--\x3e")){if(p.id=i[a],/^NOTE($|[ \t])/.test(p.id)){for(a++;""!=i[a]&&null!=i[a];)-1!=i[a].indexOf("--\x3e")&&o("Cannot have timestamp in a comment."),a++;continue}if(""==i[++a]||null==i[a]){o("Cue identifier cannot be standalone.");continue}-1==i[a].indexOf("--\x3e")&&(d=!1,o("Cue identifier needs to be followed by timestamp."))}r=!1;var g=new WebVTTCueTimingsAndSettingsParser(i[a],o),v=0;if(s.length>0&&(v=s[s.length-1].startTime),!d||g.parse(p,v)){for(a++;""!=i[a]&&null!=i[a];){if(-1!=i[a].indexOf("--\x3e")){o("Blank line missing before cue."),r=!0;break}""!=p.text&&(p.text+="\n"),p.text+=i[a],a++}var h=new WebVTTCueTextParser(p.text,o,t);p.tree=h.parse(p.startTime,p.endTime),s.push(p)}else for(p=null,a++;""!=i[a]&&null!=i[a];){if(-1!=i[a].indexOf("--\x3e")){r=!0;break}a++}}return s.sort(function(e,t){return e.startTime<t.startTime?-1:e.startTime>t.startTime?1:e.endTime>t.endTime?-1:e.endTime<t.endTime?1:0}),{cues:s,errors:l,time:Date.now()-n}}},WebVTTCueTimingsAndSettingsParser=function(e,t){var n=/[\u0020\t\f]/,a=/[^\u0020\t\f]/,i=(e=e,0),r=function(e){t(e,i+1)};function s(t){for(;null!=e[i]&&t.test(e[i]);)i++}function l(t){for(var n="";null!=e[i]&&t.test(e[i]);)n+=e[i],i++;return n}function o(){var t,n,a,s,o="minutes";if(null!=e[i])if(/\d/.test(e[i]))if(((t=l(/\d/)).length>2||parseInt(t,10)>59)&&(o="hours"),":"==e[i])if(i++,2==(n=l(/\d/)).length){if("hours"==o||":"==e[i]){if(":"!=e[i])return void r("No seconds found or minutes is greater than 59.");if(i++,2!=(a=l(/\d/)).length)return void r("Must be exactly two digits.")}else a=n,n=t,t="0";if("."==e[i])if(i++,3==(s=l(/\d/)).length)if(parseInt(n,10)>59)r("You cannot have more than 59 minutes.");else{if(!(parseInt(a,10)>59))return 60*parseInt(t,10)*60+60*parseInt(n,10)+parseInt(a,10)+parseInt(s,10)/1e3;r("You cannot have more than 59 seconds.")}else r("Milliseconds must be given in three digits.");else r('No decimal separator (".") found.')}else r("Must be exactly two digits.");else r("No time unit separator found.");else r("Timestamp must start with a character in the range 0-9.");else r("No timestamp found.")}this.parse=function(t,l){if(s(n),t.startTime=o(),null!=t.startTime)if(t.startTime<l&&r("Start timestamp is not greater than or equal to start timestamp of previous cue."),a.test(e[i])&&r("Timestamp not separated from '--\x3e' by whitespace."),s(n),"-"==e[i])if("-"==e[++i])if(">"==e[++i]){if(i++,a.test(e[i])&&r("'--\x3e' not separated from timestamp by whitespace."),s(n),t.endTime=o(),null!=t.endTime)return t.endTime<=t.startTime&&r("End timestamp is not greater than start timestamp."),a.test(e[i])&&!1,s(n),function(e,t){for(var a=e.split(n),i=[],s=0;s<a.length;s++)if(""!=a[s]){var l=a[s].indexOf(":"),o=a[s].slice(0,l);if(value=a[s].slice(l+1),-1!=i.indexOf(o)&&r("Duplicate setting."),i.push(o),""==value)return void r("No value for setting defined.");if("vertical"==o){if("rl"!=value&&"lr"!=value){r("Writing direction can only be set to 'rl' or 'rl'.");continue}t.direction=value}else if("line"==o){if(!/\d/.test(value)){r("Line position takes a number or percentage.");continue}if(-1!=value.indexOf("-",1)){r("Line position can only have '-' at the start.");continue}if(-1!=value.indexOf("%")&&value.indexOf("%")!=value.length-1){r("Line position can only have '%' at the end.");continue}if("-"==value[0]&&"%"==value[value.length-1]){r("Line position cannot be a negative percentage.");continue}if("%"==value[value.length-1]){if(parseInt(value,10)>100){r("Line position cannot be >100%.");continue}t.snapToLines=!1}t.linePosition=parseInt(value,10)}else if("position"==o){if("%"!=value[value.length-1]){r("Text position must be a percentage.");continue}if(parseInt(value,10)>100){r("Size cannot be >100%.");continue}t.textPosition=parseInt(value,10)}else if("size"==o){if("%"!=value[value.length-1]){r("Size must be a percentage.");continue}if(parseInt(value,10)>100){r("Size cannot be >100%.");continue}t.size=parseInt(value,10)}else if("align"==o){var u=["start","middle","end","left","right"];if(-1==u.indexOf(value)){r("Alignment can only be set to one of "+u.join(", ")+".");continue}t.alignment=value}else r("Invalid setting.")}}(e.substring(i),t),!0}else r("No valid timestamp separator found.");else r("No valid timestamp separator found.");else r("No valid timestamp separator found.")},this.parseTimestamp=function(){var t=o();if(null==e[i])return t;r("Timestamp must not have trailing characters.")}},WebVTTCueTextParser=function(e,t,n){e=e;var a=0,i=function(e){"metadata"!=n&&t(e,a+1)};function r(){for(var t="data",n="",r="",s=[];null!=e[a-1]||0==a;){var l=e[a];if("data"==t)if("&"==l)r=l,t="escape";else if("<"==l&&""==n)t="tag";else{if("<"==l||null==l)return["text",n];n+=l}else if("escape"==t)if("&"==l)i("Incorrect escape."),n+=r,r=l;else if(/[abglmnsprt]/.test(l))r+=l;else if(";"==l)"&amp"==r?n+="&":"&lt"==r?n+="<":"&gt"==r?n+=">":"&lrm"==r?n+="‎":"&rlm"==r?n+="‏":"&nbsp"==r?n+=" ":(i("Incorrect escape."),n+=r+";"),t="data";else{if("<"==l||null==l)return i("Incorrect escape."),["text",n+=r];i("Incorrect escape."),n+=r+l,t="data"}else if("tag"==t)if("\t"==l||"\n"==l||"\f"==l||" "==l)t="start tag annotation";else if("."==l)t="start tag class";else if("/"==l)t="end tag";else if(/\d/.test(l))n=l,t="timestamp tag";else{if(">"==l||null==l)return">"==l&&a++,["start tag","",[],""];n=l,t="start tag"}else if("start tag"==t)if("\t"==l||"\f"==l||" "==l)t="start tag annotation";else if("\n"==l)r=l,t="start tag annotation";else if("."==l)t="start tag class";else{if(">"==l||null==l)return">"==l&&a++,["start tag",n,[],""];n+=l}else if("start tag class"==t)if("\t"==l||"\f"==l||" "==l)s.push(r),r="",t="start tag annotation";else if("\n"==l)s.push(r),r=l,t="start tag annotation";else if("."==l)s.push(r),r="";else{if(">"==l||null==l)return">"==l&&a++,s.push(r),["start tag",n,s,""];r+=l}else if("start tag annotation"==t){if(">"==l||null==l)return">"==l&&a++,["start tag",n,s,r=r.split(/[\u0020\t\f\r\n]+/).filter(function(e){if(e)return!0}).join(" ")];r+=l}else if("end tag"==t){if(">"==l||null==l)return">"==l&&a++,["end tag",n];n+=l}else if("timestamp tag"==t){if(">"==l||null==l)return">"==l&&a++,["timestamp",n];n+=l}else i("Never happens.");a++}}this.parse=function(t,s){var l={children:[]},o=l,u=[];function f(e){o.children.push({type:"object",name:e[1],classes:e[2],children:[],parent:o}),o=o.children[o.children.length-1]}function c(e){for(var t=o;t;){if(t.name==e)return!0;t=t.parent}}for(;null!=e[a];){var m=r();if("text"==m[0])o.children.push({type:"text",value:m[1],parent:o});else if("start tag"==m[0]){"chapters"==n&&i("Start tags not allowed in chapter title text.");var p=m[1];"v"!=p&&"lang"!=p&&""!=m[3]&&i("Only <v> and <lang> can have an annotation."),"c"==p||"i"==p||"b"==p||"u"==p||"ruby"==p?f(m):"rt"==p&&"ruby"==o.name?f(m):"v"==p?(c("v")&&i("<v> cannot be nested inside itself."),f(m),o.value=m[3],m[3]||i("<v> requires an annotation.")):"lang"==p?(f(m),o.value=m[3]):i("Incorrect start tag.")}else if("end tag"==m[0])"chapters"==n&&i("End tags not allowed in chapter title text."),m[1]==o.name?o=o.parent:"ruby"==m[1]&&"rt"==o.name?o=o.parent.parent:i("Incorrect end tag.");else if("timestamp"==m[0]){"chapters"==n&&i("Timestamp not allowed in chapter title text.");var d=new WebVTTCueTimingsAndSettingsParser(m[1],i).parseTimestamp();null!=d&&((d<=t||d>=s)&&i("Timestamp must be between start timestamp and end timestamp."),u.length>0&&u[u.length-1]>=d&&i("Timestamp must be greater than any previous timestamp."),o.children.push({type:"timestamp",value:d,parent:o}),u.push(d))}}for(;o.parent;)"v"!=o.name&&i("Required end tag missing."),o=o.parent;return l}},WebVTTSerializer=function(){function e(e){return e.startTime+" "+e.endTime+"\n"+function e(t){for(var n="",a=0;a<t.length;a++){var i=t[a];if("text"==i.type)n+=i.value;else if("object"==i.type){if(n+="<"+i.name,i.classes)for(var r=0;r<i.classes.length;r++)n+="."+i.classes[r];i.value&&(n+=" "+i.value),n+=">",i.children&&(n+=e(i.children)),n+="</"+i.name+">"}else n+="<"+i.value+">"}return n}(e.tree.children)+"\n\n"}this.serialize=function(t){for(var n="",a=0;a<t.length;a++)n+=e(t[a]);return n}};